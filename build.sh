#!/usr/bin/env bash

readonly sourcedir="${SOURCE_DIR:-${PWD}}"
readonly builddir="${BUILD_DIR:-${sourcedir}/build}"

readonly conanpath="${CONAN_PATH:-${sourcedir}}"
readonly conanuser="${CONAN_USER:-jw3}"
readonly conanchannel="${CONAN_CHANNEL:-pure}"

_echoerr() { if [[ ${QUIET} -ne 1 ]]; then echo "[debug]: $@" 1>&2; fi }
_checkerr() { ec=${1}; if [[ ${ec} -ne 0 ]]; then _echoerr "$2 failed with error code $ec"; exit ${ec}; fi }
_checkec() { ec=${?}; _checkerr ${ec} "$1"; }

build() {
  IFS=' ' read -r -a ext_cmake_args <<< "$CMAKE_ARGS"

  if [[ ! -d ${builddir} ]]; then mkdir -p "$builddir"; fi
  cd ${builddir}
  cmake ${ext_cmake_args[@]} ${sourcedir}
  _checkec "cmake"

  cd ${sourcedir}/packages

  # export the version generated by cmake
  export BUILD_DIR=${builddir}

  # export each conan package
  _exportpkg common
  _exportpkg OneWire
  _exportpkg DS18B20
  _exportpkg TinyGpsPlus
  _exportpkg LiquidCrystalI2C
  _exportpkg AssetTrackerRK
  _exportpkg LIS3DH
  _exportpkg NeoGPS
}


publish() {
  if [[ ! -d ${builddir} ]]; then mkdir -p "$builddir"; fi
  cd ${builddir}
  cmake ${sourcedir}

  version="${CONAN_VERSION:-$(cat ${builddir}/VERSION)}"
  remote="${CONAN_REMOTE:-particle-bintray}"

  _echoerr "conan upload $conanuser/$conanchannel"
  publishpkg particle-common
  publishpkg OneWire
  publishpkg DS18B20
  publishpkg TinyGpsPlus
  publishpkg LiquidCrystalI2C
  publishpkg AssetTrackerRK
  publishpkg LIS3DH
  publishpkg NeoGPS
}


_exportpkg() {
  local name="$1"
  conan export-pkg "$name" "$conanuser/$conanchannel" -f -s compiler.version=5
}


_publishpkg() {
  local name="$1"
  conan upload "$name/$version@$conanuser/$conanchannel" -c -r "$remote" --all
}

case "${1,,}" in
  ("publish") publish ;;
          (*) build "$@" ;;
esac
